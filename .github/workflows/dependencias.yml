name: Detectar dependencias .sql con GitHub Actions 

on:
  push:
    branches:
      - '**'
jobs:
  show-sql:
    runs-on: ubuntu-latest
    steps:
      # Clonar repositorio al runner de GitHub
      - name: Checkout del código
        uses: actions/checkout@v3
        with:
          fetch-depth: 0   # Todas las ramas y commits

      # Step para obtener el contenido de cada .sql de cada rama
      - name: Guardar contenido de .sql en variable de entorno
        run: |
          git fetch --all
          # Variable de entorne para que use el próximo step para la detección de dependencias
          SQL_CONTENT=""
          for branch in $(git branch -r | grep -v '\->'); do
            commit=$(git rev-parse $branch)
            files=$(git ls-tree -r --name-only $commit | grep '\.sql$' || true)
            for f in $files; do
              content=$(git show $commit:$f)
              SQL_CONTENT="$SQL_CONTENT\n--- $branch/$f ---\n$content"
            done
          done
          # Exportar variable para siguientes steps
          echo "SQL_CONTENT<<EOF" >> $GITHUB_ENV
          echo -e "$SQL_CONTENT" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Ejecutar script Python del repo
        run: |
          echo "$SQL_CONTENT"
